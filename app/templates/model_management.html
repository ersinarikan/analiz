<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Model Yönetimi - WSANALIZ</title>
    
    <!-- Favicon -->
    <link rel="icon" href="{{ url_for('static', filename='favicon.ico') }}" type="image/x-icon">
    <link rel="shortcut icon" href="{{ url_for('static', filename='favicon.ico') }}" type="image/x-icon">
    
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    
    <!-- Custom CSS -->
    <link href="{{ url_for('static', filename='css/style.css') }}" rel="stylesheet">
    <style>
        .model-card {
            transition: transform 0.2s;
        }
        .model-card:hover {
            transform: translateY(-2px);
        }
        .version-badge {
            font-size: 0.8em;
        }
        .metric-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }
        .status-active {
            color: #28a745;
        }
        .status-inactive {
            color: #6c757d;
        }
    </style>
</head>
<body>
    <!-- Navbar -->
    <nav class="navbar navbar-expand-lg navbar-dark mb-4">
        <div class="container">
            <a class="navbar-brand" href="/">
                <i class="fas fa-shield-alt me-2"></i>
                WS<span>Analiz</span>
            </a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav" aria-controls="navbarNav" aria-expanded="false" aria-label="Toggle navigation">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav ms-auto">
                    <li class="nav-item">
                        <a class="nav-link" href="/"><i class="fas fa-home me-1"></i> Ana Sayfa</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="#" id="modelMetricsBtn"><i class="fas fa-chart-line me-1"></i> Model Metrikleri</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link active" href="/model-management"><i class="fas fa-cogs me-1"></i> Model Yönetimi</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="#" data-bs-toggle="modal" data-bs-target="#analysisParamsModal" id="openAnalysisParamsModalBtn"><i class="fas fa-cog me-1"></i> Analiz Parametreleri</a>
                    </li>
                </ul>
            </div>
        </div>
    </nav>

    <div class="container mt-4">
        <div class="row">
            <div class="col-12">
                <h1 class="mb-4">
                    <i class="fas fa-cogs me-2"></i>Model Yönetimi
                </h1>
            </div>
        </div>

        <!-- Sistem Temizliği Bölümü -->
        <div class="card mb-4">
            <div class="card-header">
                <h5 class="card-title mb-0">
                    <i class="fas fa-broom"></i> Sistem Temizliği
                </h5>
            </div>
            <div class="card-body">
                <div class="row mb-3">
                    <div class="col-md-12">
                        <div id="cleanup-status" class="alert alert-info">
                            <i class="fas fa-info-circle"></i> Temizlik durumu yükleniyor...
                        </div>
                    </div>
                </div>
                
                <div class="row">
                    <div class="col-md-6">
                        <h6>Hızlı Temizlik</h6>
                        <div class="btn-group-vertical d-grid gap-2">
                            <button class="btn btn-outline-warning" onclick="cleanupFeedback('age')">
                                <i class="fas fa-user-clock"></i> Yaş Feedback Temizle
                            </button>
                            <button class="btn btn-outline-warning" onclick="cleanupFeedback('content')">
                                <i class="fas fa-image"></i> İçerik Feedback Temizle
                            </button>
                            <button class="btn btn-outline-info" onclick="cleanupEnsembleFiles('age')">
                                <i class="fas fa-file-archive"></i> Yaş Ensemble Dosyaları
                            </button>
                            <button class="btn btn-outline-info" onclick="cleanupEnsembleFiles('content')">
                                <i class="fas fa-file-archive"></i> İçerik Ensemble Dosyaları
                            </button>
                            <button class="btn btn-outline-secondary" onclick="cleanupUnusedFrames()">
                                <i class="fas fa-images"></i> Kullanılmayan Frame'ler
                            </button>
                            <button class="btn btn-outline-primary" onclick="vacuumDatabase()">
                                <i class="fas fa-database"></i> Veritabanı Optimize
                            </button>
                        </div>
                    </div>
                    
                    <div class="col-md-6">
                        <h6>Kapsamlı Temizlik</h6>
                        <div class="mb-3">
                            <label class="form-label">Saklanacak Model Versiyonu:</label>
                            <input type="number" id="keep-model-versions" class="form-control" value="5" min="1" max="20">
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Saklanacak Feedback Sayısı:</label>
                            <input type="number" id="keep-feedback-count" class="form-control" value="100" min="10" max="1000">
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Saklanacak Ensemble Versiyonu:</label>
                            <input type="number" id="keep-ensemble-versions" class="form-control" value="3" min="1" max="10">
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Silinecek Frame Yaşı (gün):</label>
                            <input type="number" id="unused-frames-days" class="form-control" value="30" min="1" max="365">
                        </div>
                        <button class="btn btn-danger w-100" onclick="comprehensiveCleanup()">
                            <i class="fas fa-broom"></i> Kapsamlı Temizlik Başlat
                        </button>
                    </div>
                </div>
                
                <div class="row mt-4">
                    <div class="col-md-12">
                        <div id="cleanup-results" class="alert alert-secondary d-none">
                            <h6>Temizlik Sonuçları:</h6>
                            <div id="cleanup-details"></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Model Kartları -->
        <div class="row">
            <!-- Yaş Tahmin Modeli -->
            <div class="col-md-6 mb-4">
                <div class="card model-card h-100">
                    <div class="card-header bg-primary text-white">
                        <h5 class="mb-0">
                            <i class="fas fa-user-clock me-2"></i>Yaş Tahmin Modeli
                        </h5>
                    </div>
                    <div class="card-body">
                        <div class="row mb-3">
                            <div class="col-6">
                                <small class="text-muted">Aktif Versiyon:</small>
                                <div class="fw-bold" id="age-active-version">Yükleniyor...</div>
                            </div>
                            <div class="col-6">
                                <small class="text-muted">Durum:</small>
                                <div id="age-status">
                                    <i class="fas fa-spinner fa-spin"></i> Kontrol ediliyor...
                                </div>
                            </div>
                        </div>
                        
                        <div class="row mb-3">
                            <div class="col-6">
                                <small class="text-muted">Eğitim Verisi:</small>
                                <div class="fw-bold" id="age-training-data">-</div>
                            </div>
                            <div class="col-6">
                                <small class="text-muted">Son MAE:</small>
                                <div class="fw-bold" id="age-mae">-</div>
                            </div>
                        </div>

                        <div class="mb-3">
                            <h6>Model Versiyonları:</h6>
                            <div id="age-versions" class="mb-3">
                                <div class="text-center">
                                    <i class="fas fa-spinner fa-spin"></i> Yükleniyor...
                                </div>
                            </div>
                        </div>

                        <div class="d-grid gap-2">
                            <button class="btn btn-success" onclick="trainModel('age')">
                                <i class="fas fa-refresh me-2"></i>Corrections Yenile
                            </button>
                            <button class="btn btn-warning" onclick="resetModel('age')">
                                <i class="fas fa-undo me-2"></i>Ensemble Sıfırla
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- CLIP Fine-tuning Modeli -->
            <div class="col-md-6 mb-4">
                <div class="card model-card h-100">
                    <div class="card-header bg-info text-white">
                        <h5 class="mb-0">
                            <i class="fas fa-brain me-2"></i>CLIP Fine-tuning Modeli
                        </h5>
                    </div>
                    <div class="card-body">
                        <div class="row mb-3">
                            <div class="col-6">
                                <small class="text-muted">Aktif Versiyon:</small>
                                <div class="fw-bold" id="clip-active-version">Yükleniyor...</div>
                            </div>
                            <div class="col-6">
                                <small class="text-muted">Durum:</small>
                                <div id="clip-status">
                                    <i class="fas fa-spinner fa-spin"></i> Kontrol ediliyor...
                                </div>
                            </div>
                        </div>
                        
                        <div class="row mb-3">
                            <div class="col-6">
                                <small class="text-muted">Feedback Sayısı:</small>
                                <div class="fw-bold" id="clip-feedback-count">-</div>
                            </div>
                            <div class="col-6">
                                <small class="text-muted">Kategoriler:</small>
                                <div class="fw-bold">5</div>
                            </div>
                        </div>

                        <div class="mb-3">
                            <h6>Model Versiyonları:</h6>
                            <div id="clip-versions" class="mb-3">
                                <div class="text-center">
                                    <i class="fas fa-spinner fa-spin"></i> Yükleniyor...
                                </div>
                            </div>
                        </div>

                        <div class="mb-3">
                            <h6>Eğitim Geçmişi:</h6>
                            <div id="clip-training-sessions" class="mb-3">
                                <div class="text-center">
                                    <i class="fas fa-spinner fa-spin"></i> Yükleniyor...
                                </div>
                            </div>
                        </div>

                        <div class="d-grid gap-2">
                            <button class="btn btn-success" onclick="trainModel('content')" id="clip-train-btn">
                                <i class="fas fa-refresh me-2"></i>CLIP Corrections Yenile
                            </button>
                            <button class="btn btn-warning" onclick="showClipVersions()" id="clip-versions-btn">
                                <i class="fas fa-list me-2"></i>Versiyonları Yönet
                            </button>
                            <button class="btn btn-info" onclick="reloadContentAnalyzer()" id="reload-analyzer-btn">
                                <i class="fas fa-sync me-2"></i>CLIP Modelini Yeniden Yükle
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Eğitim Durumu -->
        <div class="row mt-4">
            <div class="col-12">
                <div class="card">
                    <div class="card-header">
                        <h5 class="mb-0">
                            <i class="fas fa-chart-line me-2"></i>Eğitim Durumu
                        </h5>
                    </div>
                    <div class="card-body">
                        <div id="training-status" class="alert alert-info" style="display: none;">
                            <i class="fas fa-info-circle me-2"></i>
                            <span id="training-message">Eğitim durumu bekleniyor...</span>
                        </div>
                        
                        <div id="training-progress" style="display: none;">
                            <div class="progress mb-3">
                                <div class="progress-bar progress-bar-striped progress-bar-animated" 
                                     role="progressbar" style="width: 0%" id="progress-bar">
                                </div>
                            </div>
                            <div class="row">
                                <div class="col-md-3">
                                    <small class="text-muted">Epoch:</small>
                                    <div class="fw-bold" id="current-epoch">-</div>
                                </div>
                                <div class="col-md-3">
                                    <small class="text-muted">Loss:</small>
                                    <div class="fw-bold" id="current-loss">-</div>
                                </div>
                                <div class="col-md-3">
                                    <small class="text-muted">MAE:</small>
                                    <div class="fw-bold" id="current-mae">-</div>
                                </div>
                                <div class="col-md-3">
                                    <small class="text-muted">Süre:</small>
                                    <div class="fw-bold" id="training-duration">-</div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    
    <script>
        // Model yönetimi JavaScript fonksiyonları
        let trainingInterval = null;
        let queueStatusInterval = null;

        // Sayfa yüklendiğinde model bilgilerini getir
        document.addEventListener('DOMContentLoaded', function() {
            loadModelVersions();
            loadModelStats();
            loadClipData(); // CLIP verilerini yükle
            startQueueStatusChecker();
            setupNavbarEventHandlers();
            loadCleanupStatus(); // Temizlik durumunu yükle
            setInterval(loadCleanupStatus, 30000); // Her 30 saniyede bir durumu güncelle
        });

        // Navbar butonları için event handler'ları kur
        function setupNavbarEventHandlers() {
            // Model Metrikleri butonu
            const modelMetricsBtn = document.getElementById('modelMetricsBtn');
            if (modelMetricsBtn) {
                modelMetricsBtn.addEventListener('click', function(e) {
                    if (this.classList.contains('disabled')) {
                        e.preventDefault();
                        e.stopPropagation();
                        alert('Dosya yüklü veya analiz devam ederken model metrikleri görüntülenemez.');
                    }
                });
            }

            // Analiz Parametreleri butonu
            const analysisParamsBtn = document.getElementById('openAnalysisParamsModalBtn');
            if (analysisParamsBtn) {
                analysisParamsBtn.addEventListener('click', function(e) {
                    if (this.classList.contains('disabled')) {
                        e.preventDefault();
                        e.stopPropagation();
                        alert('Dosya yüklü veya analiz devam ederken analiz parametreleri değiştirilemez.');
                    }
                });
            }
        }

        // Kuyruk durumu kontrolünü başlat
        function startQueueStatusChecker() {
            // İlk kontrol
            checkQueueStatus();
            
            // 5 saniyede bir kontrol et
            queueStatusInterval = setInterval(checkQueueStatus, 5000);
        }

        // Kuyruk durumunu kontrol et
        function checkQueueStatus() {
            // Hem kuyruk durumunu hem de yüklü dosya sayısını al
            Promise.all([
                fetch('/api/debug/queue-status').then(response => response.json()),
                fetch('/api/debug/uploaded-files-count').then(response => response.json())
            ])
            .then(([queueData, uploadedFilesData]) => {
                updateModelManagementButtonsState(queueData, uploadedFilesData);
            })
            .catch(error => {
                console.error('Kuyruk durumu kontrol hatası:', error);
            });
        }

        // Model yönetimi butonlarının durumunu güncelle
        function updateModelManagementButtonsState(queueData, uploadedFilesData) {
            console.log('Kuyruk durumu:', queueData); // Debug için
            console.log('Yüklü dosya durumu:', uploadedFilesData); // Debug için
            
            // Ana sayfadaki mantık: Yüklü dosya varsa veya kuyrukta dosya varsa veya aktif analiz varsa devre dışı bırak
            const hasUploadedFiles = uploadedFilesData.uploaded_files_count > 0;
            const hasFilesInQueue = queueData.queue_size > 0 || queueData.active_analyses > 0;
            const shouldDisableButtons = hasUploadedFiles || hasFilesInQueue;
            
            console.log('Ana sayfada yüklü dosya var mı?', hasUploadedFiles); // Debug için
            console.log('Kuyrukta dosya var mı?', hasFilesInQueue); // Debug için
            console.log('Butonlar devre dışı mı?', shouldDisableButtons); // Debug için
            
            // Tüm model yönetimi butonlarını bul
            const trainButtons = document.querySelectorAll('[onclick*="trainModel"]');
            const resetButtons = document.querySelectorAll('[onclick*="resetModel"]');
            const activateButtons = document.querySelectorAll('[onclick*="activateVersion"]');
            
            // Navbar'daki butonları da kontrol et
            const navbarButtons = document.querySelectorAll('#modelMetricsBtn, #openAnalysisParamsModalBtn');
            
            if (shouldDisableButtons) {
                // Dosya yüklü veya kuyrukta dosya varken butonları devre dışı bırak
                trainButtons.forEach(btn => {
                    btn.disabled = true;
                    btn.classList.add('disabled');
                    btn.title = 'Dosya yüklü veya analiz devam ederken model eğitimi yapılamaz';
                });
                
                resetButtons.forEach(btn => {
                    btn.disabled = true;
                    btn.classList.add('disabled');
                    btn.title = 'Dosya yüklü veya analiz devam ederken model sıfırlanamaz';
                });
                
                activateButtons.forEach(btn => {
                    btn.disabled = true;
                    btn.classList.add('disabled');
                    btn.title = 'Dosya yüklü veya analiz devam ederken model değiştirilemez';
                });
                
                // Navbar butonlarını da devre dışı bırak
                navbarButtons.forEach(btn => {
                    btn.classList.add('disabled');
                    btn.setAttribute('aria-disabled', 'true');
                    if (btn.id === 'openAnalysisParamsModalBtn') {
                        btn.removeAttribute('data-bs-toggle');
                        btn.removeAttribute('data-bs-target');
                        btn.title = 'Dosya yüklü veya analiz devam ederken parametreler değiştirilemez';
                    } else {
                        btn.title = 'Dosya yüklü veya analiz devam ederken bu işlem yapılamaz';
                    }
                });
                
            } else {
                // Dosya yüklü değil ve analiz yokken butonları aktif et
                trainButtons.forEach(btn => {
                    btn.disabled = false;
                    btn.classList.remove('disabled');
                    btn.title = '';
                });
                
                resetButtons.forEach(btn => {
                    btn.disabled = false;
                    btn.classList.remove('disabled');
                    btn.title = '';
                });
                
                activateButtons.forEach(btn => {
                    btn.disabled = false;
                    btn.classList.remove('disabled');
                    btn.title = '';
                });
                
                // Navbar butonlarını da aktif et
                navbarButtons.forEach(btn => {
                    btn.classList.remove('disabled');
                    btn.setAttribute('aria-disabled', 'false');
                    if (btn.id === 'openAnalysisParamsModalBtn') {
                        btn.setAttribute('data-bs-toggle', 'modal');
                        btn.setAttribute('data-bs-target', '#analysisParamsModal');
                    }
                    btn.title = '';
                });
            }
        }

        // Ensemble model versiyonlarını yükle
        async function loadModelVersions() {
            try {
                // Yaş ensemble versiyonları
                const ageResponse = await fetch('/api/ensemble/versions/age');
                if (ageResponse.ok) {
                    const ageData = await ageResponse.json();
                    console.log('Age Ensemble API Response:', ageData); // Debug için
                    
                    // API response'da versions array'i var
                    const ageVersions = ageData.versions || [];
                    console.log('Age Ensemble Versions:', ageVersions); // Debug için
                    displayVersions('age', ageVersions);
                } else {
                    console.error('Age Ensemble API Error:', ageResponse.status, ageResponse.statusText);
                    document.getElementById('age-versions').innerHTML = '<span class="text-danger">Ensemble API hatası</span>';
                }

                // CLIP ensemble versiyonları
                const clipResponse = await fetch('/api/ensemble/versions/content');
                if (clipResponse.ok) {
                    const clipData = await clipResponse.json();
                    console.log('CLIP Ensemble API Response:', clipData); // Debug için
                    
                    // API response'da versions array'i var
                    const clipVersions = clipData.versions || [];
                    console.log('CLIP Ensemble Versions:', clipVersions); // Debug için
                    displayVersions('content', clipVersions);
                } else {
                    console.error('CLIP Ensemble API Error:', clipResponse.status, clipResponse.statusText);
                    document.getElementById('clip-versions').innerHTML = '<span class="text-danger">Ensemble API hatası</span>';
                }
            } catch (error) {
                console.error('Ensemble versiyonları yüklenirken hata:', error);
                document.getElementById('age-versions').innerHTML = '<span class="text-danger">Ensemble yükleme hatası</span>';
                document.getElementById('clip-versions').innerHTML = '<span class="text-danger">Ensemble yükleme hatası</span>';
            }
        }

        // Ensemble model istatistiklerini yükle
        async function loadModelStats() {
            try {
                // Yaş ensemble istatistikleri
                const ageResponse = await fetch('/api/ensemble/stats/age');
                if (ageResponse.ok) {
                    const ageStats = await ageResponse.json();
                    updateEnsembleStats('age', ageStats);
                }

                // CLIP ensemble istatistikleri
                const clipResponse = await fetch('/api/ensemble/stats/content');
                if (clipResponse.ok) {
                    const clipStats = await clipResponse.json();
                    updateEnsembleStats('content', clipStats);
                }
            } catch (error) {
                console.error('Ensemble istatistikleri yüklenirken hata:', error);
            }
        }

        // Model versiyonlarını göster
        function displayVersions(modelType, versions) {
            const container = document.getElementById(`${modelType}-versions`);
            console.log(`Displaying ${modelType} versions:`, versions); // Debug için
            
            // Versions'ın array olduğundan emin ol
            if (!Array.isArray(versions) || versions.length === 0) {
                container.innerHTML = '<span class="text-muted">Henüz eğitilmiş versiyon yok</span>';
                
                // Aktif versiyon bilgilerini güncelle
                if (modelType === 'age') {
                    // Age model için de base model varsa v0 göster
                    document.getElementById('age-active-version').textContent = 'v0';
                    document.getElementById('age-status').innerHTML = '<i class="fas fa-check-circle status-active"></i> Aktif';
                } else if (modelType === 'content') {
                    // Content model için her zaman base OpenCLIP çalışıyor
                    document.getElementById('clip-active-version').textContent = 'v0';
                    document.getElementById('clip-status').innerHTML = '<i class="fas fa-check-circle status-active"></i> Aktif';
                }
                return;
            }

            let html = '';
            let activeVersionFound = false;
            
            versions.forEach(version => {
                const badgeClass = version.is_active ? 'bg-success' : 'bg-secondary';
                const activeText = version.is_active ? ' (Aktif)' : '';
                
                // Version ismi gösterimi
                let versionDisplay = '';
                if (version.version === 0) {
                    versionDisplay = `v0 (${version.version_name === 'base_openclip' ? 'En Son' : 
                                   version.version_name === 'base_model' ? 'En Son' : 
                                   'Base'})`;
                } else {
                    versionDisplay = `v${version.version}`;
                }
                
                html += `
                    <span class="badge ${badgeClass} version-badge me-2 mb-2">
                        ${versionDisplay}${activeText}
                        <button class="btn btn-sm btn-link text-white p-0 ms-2" 
                                onclick="activateVersion(${version.id})" 
                                ${version.is_active ? 'disabled' : ''}>
                            <i class="fas fa-play"></i>
                        </button>
                    </span>
                `;
                
                if (version.is_active) {
                    activeVersionFound = true;
                }
            });
            
            container.innerHTML = html;

            // Aktif versiyonu güncelle
            const activeVersion = versions.find(v => v.is_active);
            console.log('Active version found:', activeVersion); // Debug için
            
            if (modelType === 'age') {
                if (activeVersion) {
                    const versionDisplay = activeVersion.version === 0 ? 'v0' : `v${activeVersion.version}`;
                    document.getElementById('age-active-version').textContent = versionDisplay;
                    document.getElementById('age-status').innerHTML = 
                        '<i class="fas fa-check-circle status-active"></i> Aktif';
                    
                    // MAE bilgisini de güncelle
                    if (activeVersion.metrics && activeVersion.metrics.mae) {
                        document.getElementById('age-mae').textContent = `${activeVersion.metrics.mae.toFixed(2)} yaş`;
                    }
                } else {
                    // Age model için de base model varsa v0 göster
                    document.getElementById('age-active-version').textContent = 'v0';
                    document.getElementById('age-status').innerHTML = '<i class="fas fa-check-circle status-active"></i> Aktif';
                }
            } else if (modelType === 'content') {
                if (activeVersion) {
                    const versionDisplay = activeVersion.version === 0 ? 'v0' : `v${activeVersion.version}`;
                    document.getElementById('clip-active-version').textContent = versionDisplay;
                    document.getElementById('clip-status').innerHTML = '<i class="fas fa-check-circle status-active"></i> Aktif';
                } else {
                    document.getElementById('clip-active-version').textContent = 'v0';
                    document.getElementById('clip-status').innerHTML = '<i class="fas fa-check-circle status-active"></i> Aktif';
                }
            }
        }

        // Temizlik durumunu yükle
        function loadCleanupStatus() {
            fetch('/api/model-management/cleanup/status')
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        const status = data.status;
                        document.getElementById('cleanup-status').innerHTML = `
                            <div class="row">
                                <div class="col-md-3">
                                    <strong>Veritabanı:</strong> ${status.database_size_mb} MB
                                </div>
                                <div class="col-md-3">
                                    <strong>Feedback:</strong> ${status.feedback_records.age + status.feedback_records.content} kayıt
                                </div>
                                <div class="col-md-3">
                                    <strong>Model Versiyonları:</strong> ${status.model_versions.age + status.model_versions.content}
                                </div>
                                <div class="col-md-3">
                                    <strong>Ensemble:</strong> ${(status.ensemble_storage_mb.age + status.ensemble_storage_mb.content).toFixed(2)} MB
                                </div>
                            </div>
                        `;
                    } else {
                        document.getElementById('cleanup-status').innerHTML = `
                            <i class="fas fa-exclamation-triangle"></i> Temizlik durumu yüklenemedi: ${data.error}
                        `;
                    }
                })
                .catch(error => {
                    console.error('Cleanup status error:', error);
                    document.getElementById('cleanup-status').innerHTML = `
                        <i class="fas fa-exclamation-triangle"></i> Temizlik durumu yüklenirken hata oluştu
                    `;
                });
        }

        // Feedback temizliği
        function cleanupFeedback(modelType) {
            const keepCount = document.getElementById('keep-feedback-count').value;
            
            if (!confirm(`${modelType} modeli için ${keepCount} adet feedback kaydı hariç geri kalanlar silinecek. Devam etmek istiyor musunuz?`)) {
                return;
            }
            
            showLoadingSpinner();
            
            fetch('/api/model-management/cleanup/feedback', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    model_type: modelType,
                    keep_count: parseInt(keepCount)
                })
            })
            .then(response => response.json())
            .then(data => {
                hideLoadingSpinner();
                showCleanupResults(data);
                loadCleanupStatus();
            })
            .catch(error => {
                hideLoadingSpinner();
                console.error('Cleanup feedback error:', error);
                showAlert('Feedback temizliği sırasında hata oluştu', 'danger');
            });
        }

        // Ensemble dosya temizliği
        function cleanupEnsembleFiles(modelType) {
            const keepCount = document.getElementById('keep-ensemble-versions').value;
            
            if (!confirm(`${modelType} modeli için ${keepCount} adet ensemble versiyonu hariç geri kalanlar silinecek. Devam etmek istiyor musunuz?`)) {
                return;
            }
            
            showLoadingSpinner();
            
            fetch('/api/model-management/cleanup/ensemble-files', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    model_type: modelType,
                    keep_count: parseInt(keepCount)
                })
            })
            .then(response => response.json())
            .then(data => {
                hideLoadingSpinner();
                showCleanupResults(data);
                loadCleanupStatus();
            })
            .catch(error => {
                hideLoadingSpinner();
                console.error('Cleanup ensemble files error:', error);
                showAlert('Ensemble dosya temizliği sırasında hata oluştu', 'danger');
            });
        }

        // Kullanılmayan frame temizliği
        function cleanupUnusedFrames() {
            const daysOld = document.getElementById('unused-frames-days').value;
            
            if (!confirm(`${daysOld} gün önceki kullanılmayan frame'ler silinecek. Devam etmek istiyor musunuz?`)) {
                return;
            }
            
            showLoadingSpinner();
            
            fetch('/api/model-management/cleanup/unused-frames', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    days_old: parseInt(daysOld)
                })
            })
            .then(response => response.json())
            .then(data => {
                hideLoadingSpinner();
                showCleanupResults(data);
                loadCleanupStatus();
            })
            .catch(error => {
                hideLoadingSpinner();
                console.error('Cleanup unused frames error:', error);
                showAlert('Kullanılmayan frame temizliği sırasında hata oluştu', 'danger');
            });
        }

        // Veritabanı optimize
        function vacuumDatabase() {
            if (!confirm('Veritabanı optimize edilecek. Bu işlem biraz zaman alabilir. Devam etmek istiyor musunuz?')) {
                return;
            }
            
            showLoadingSpinner();
            
            fetch('/api/model-management/database/vacuum', {
                method: 'POST'
            })
            .then(response => response.json())
            .then(data => {
                hideLoadingSpinner();
                showCleanupResults(data);
                loadCleanupStatus();
            })
            .catch(error => {
                hideLoadingSpinner();
                console.error('Vacuum database error:', error);
                showAlert('Veritabanı optimize sırasında hata oluştu', 'danger');
            });
        }

        // Kapsamlı temizlik
        function comprehensiveCleanup() {
            const config = {
                age_model_versions: parseInt(document.getElementById('keep-model-versions').value),
                content_model_versions: parseInt(document.getElementById('keep-model-versions').value),
                age_feedback_records: parseInt(document.getElementById('keep-feedback-count').value),
                content_feedback_records: parseInt(document.getElementById('keep-feedback-count').value),
                ensemble_age_versions: parseInt(document.getElementById('keep-ensemble-versions').value),
                ensemble_content_versions: parseInt(document.getElementById('keep-ensemble-versions').value),
                unused_frames_days: parseInt(document.getElementById('unused-frames-days').value),
                vacuum_database: true
            };
            
            if (!confirm('Kapsamlı sistem temizliği başlatılacak. Bu işlem uzun sürebilir ve geri alınamaz. Devam etmek istiyor musunuz?')) {
                return;
            }
            
            showLoadingSpinner();
            
            fetch('/api/model-management/cleanup', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(config)
            })
            .then(response => response.json())
            .then(data => {
                hideLoadingSpinner();
                showCleanupResults(data);
                loadCleanupStatus();
            })
            .catch(error => {
                hideLoadingSpinner();
                console.error('Comprehensive cleanup error:', error);
                showAlert('Kapsamlı temizlik sırasında hata oluştu', 'danger');
            });
        }

        // Temizlik sonuçlarını göster
        function showCleanupResults(data) {
            const resultsDiv = document.getElementById('cleanup-results');
            const detailsDiv = document.getElementById('cleanup-details');
            
            if (data.success) {
                resultsDiv.className = 'alert alert-success';
                
                if (data.operations) {
                    // Kapsamlı temizlik sonuçları
                    let html = `<p><strong>Toplam temizlenen dosya:</strong> ${data.total_cleaned_files}</p>`;
                    html += `<p><strong>Veritabanı boyutu:</strong> ${data.database_size_before} MB → ${data.database_size_after} MB</p>`;
                    html += '<h6>Detaylar:</h6><ul>';
                    
                    data.operations.forEach(op => {
                        const result = op.result;
                        html += `<li><strong>${op.operation}:</strong> `;
                        if (result.success) {
                            html += `✅ ${result.message || 'Başarılı'} (${result.cleaned_count || 0} öğe)`;
                        } else {
                            html += `❌ ${result.message || 'Hata'}`;
                        }
                        html += '</li>';
                    });
                    
                    html += '</ul>';
                    detailsDiv.innerHTML = html;
                } else {
                    // Tek işlem sonucu
                    detailsDiv.innerHTML = `<p>${data.message}</p>`;
                    if (data.cleaned_count !== undefined) {
                        detailsDiv.innerHTML += `<p><strong>Temizlenen öğe sayısı:</strong> ${data.cleaned_count}</p>`;
                    }
                }
            } else {
                resultsDiv.className = 'alert alert-danger';
                detailsDiv.innerHTML = `<p><strong>Hata:</strong> ${data.error || data.message}</p>`;
            }
            
            resultsDiv.classList.remove('d-none');
            
            // 10 saniye sonra gizle
            setTimeout(() => {
                resultsDiv.classList.add('d-none');
            }, 10000);
        }

        // Sayfa yüklendiğinde
        document.addEventListener('DOMContentLoaded', function() {
            loadModelVersions();
            loadModelStatistics();
            startQueueStatusChecker();
            setupNavbarEventHandlers();
            loadCleanupStatus();
            
            // Her 30 saniyede bir durumu güncelle
            setInterval(loadCleanupStatus, 30000);
        });
    </script>
</body>
</html>