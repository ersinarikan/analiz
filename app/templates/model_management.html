<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Model Yönetimi - WSANALIZ</title>
    
    <!-- Favicon -->
    <link rel="icon" href="{{ url_for('static', filename='favicon.ico') }}" type="image/x-icon">
    <link rel="shortcut icon" href="{{ url_for('static', filename='favicon.ico') }}" type="image/x-icon">
    
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    
    <!-- Custom CSS -->
    <link href="{{ url_for('static', filename='css/style.css') }}" rel="stylesheet">
    <style>
        .model-card {
            transition: transform 0.2s;
        }
        .model-card:hover {
            transform: translateY(-2px);
        }
        .version-badge {
            font-size: 0.8em;
        }
        .metric-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }
        .status-active {
            color: #28a745;
        }
        .status-inactive {
            color: #6c757d;
        }
    </style>
</head>
<body>
    <!-- Navbar -->
    <nav class="navbar navbar-expand-lg navbar-dark mb-4">
        <div class="container">
            <a class="navbar-brand" href="/">
                <i class="fas fa-shield-alt me-2"></i>
                WS<span>Analiz</span>
            </a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav" aria-controls="navbarNav" aria-expanded="false" aria-label="Toggle navigation">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav ms-auto">
                    <li class="nav-item">
                        <a class="nav-link" href="/"><i class="fas fa-home me-1"></i> Ana Sayfa</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="#" id="modelMetricsBtn"><i class="fas fa-chart-line me-1"></i> Model Metrikleri</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="#" id="trainModelBtn"><i class="fas fa-brain me-1"></i> Model Eğitimi</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link active" href="/model-management"><i class="fas fa-cogs me-1"></i> Model Yönetimi</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="#" data-bs-toggle="modal" data-bs-target="#analysisParamsModal" id="openAnalysisParamsModalBtn"><i class="fas fa-cog me-1"></i> Analiz Parametreleri</a>
                    </li>
                </ul>
            </div>
        </div>
    </nav>

    <div class="container mt-4">
        <div class="row">
            <div class="col-12">
                <h1 class="mb-4">
                    <i class="fas fa-cogs me-2"></i>Model Yönetimi
                </h1>
            </div>
        </div>

        <!-- Model Kartları -->
        <div class="row">
            <!-- Yaş Tahmin Modeli -->
            <div class="col-md-6 mb-4">
                <div class="card model-card h-100">
                    <div class="card-header bg-primary text-white">
                        <h5 class="mb-0">
                            <i class="fas fa-user-clock me-2"></i>Yaş Tahmin Modeli
                        </h5>
                    </div>
                    <div class="card-body">
                        <div class="row mb-3">
                            <div class="col-6">
                                <small class="text-muted">Aktif Versiyon:</small>
                                <div class="fw-bold" id="age-active-version">Yükleniyor...</div>
                            </div>
                            <div class="col-6">
                                <small class="text-muted">Durum:</small>
                                <div id="age-status">
                                    <i class="fas fa-spinner fa-spin"></i> Kontrol ediliyor...
                                </div>
                            </div>
                        </div>
                        
                        <div class="row mb-3">
                            <div class="col-6">
                                <small class="text-muted">Eğitim Verisi:</small>
                                <div class="fw-bold" id="age-training-data">-</div>
                            </div>
                            <div class="col-6">
                                <small class="text-muted">Son MAE:</small>
                                <div class="fw-bold" id="age-mae">-</div>
                            </div>
                        </div>

                        <div class="mb-3">
                            <h6>Model Versiyonları:</h6>
                            <div id="age-versions" class="mb-3">
                                <div class="text-center">
                                    <i class="fas fa-spinner fa-spin"></i> Yükleniyor...
                                </div>
                            </div>
                        </div>

                        <div class="d-grid gap-2">
                            <button class="btn btn-success" onclick="trainModel('age')">
                                <i class="fas fa-play me-2"></i>Yeni Eğitim Başlat
                            </button>
                            <button class="btn btn-warning" onclick="resetModel('age')">
                                <i class="fas fa-undo me-2"></i>Modeli Sıfırla
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- İçerik Analiz Modeli -->
            <div class="col-md-6 mb-4">
                <div class="card model-card h-100">
                    <div class="card-header bg-info text-white">
                        <h5 class="mb-0">
                            <i class="fas fa-shield-alt me-2"></i>İçerik Analiz Modeli
                        </h5>
                    </div>
                    <div class="card-body">
                        <div class="row mb-3">
                            <div class="col-6">
                                <small class="text-muted">Aktif Versiyon:</small>
                                <div class="fw-bold" id="content-active-version">CLIP-v1.0</div>
                            </div>
                            <div class="col-6">
                                <small class="text-muted">Durum:</small>
                                <div id="content-status" class="status-active">
                                    <i class="fas fa-check-circle"></i> Aktif
                                </div>
                            </div>
                        </div>
                        
                        <div class="row mb-3">
                            <div class="col-6">
                                <small class="text-muted">Eğitim Verisi:</small>
                                <div class="fw-bold" id="content-training-data">-</div>
                            </div>
                            <div class="col-6">
                                <small class="text-muted">Kategoriler:</small>
                                <div class="fw-bold">5</div>
                            </div>
                        </div>

                        <div class="mb-3">
                            <h6>Model Versiyonları:</h6>
                            <div id="content-versions" class="mb-3">
                                <span class="badge bg-primary version-badge">CLIP-v1.0 (Aktif)</span>
                            </div>
                        </div>

                        <div class="d-grid gap-2">
                            <button class="btn btn-success" onclick="trainModel('content')" disabled>
                                <i class="fas fa-play me-2"></i>Yeni Eğitim Başlat
                            </button>
                                                            <!-- Content model training is now supported -->
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Eğitim Durumu -->
        <div class="row mt-4">
            <div class="col-12">
                <div class="card">
                    <div class="card-header">
                        <h5 class="mb-0">
                            <i class="fas fa-chart-line me-2"></i>Eğitim Durumu
                        </h5>
                    </div>
                    <div class="card-body">
                        <div id="training-status" class="alert alert-info" style="display: none;">
                            <i class="fas fa-info-circle me-2"></i>
                            <span id="training-message">Eğitim durumu bekleniyor...</span>
                        </div>
                        
                        <div id="training-progress" style="display: none;">
                            <div class="progress mb-3">
                                <div class="progress-bar progress-bar-striped progress-bar-animated" 
                                     role="progressbar" style="width: 0%" id="progress-bar">
                                </div>
                            </div>
                            <div class="row">
                                <div class="col-md-3">
                                    <small class="text-muted">Epoch:</small>
                                    <div class="fw-bold" id="current-epoch">-</div>
                                </div>
                                <div class="col-md-3">
                                    <small class="text-muted">Loss:</small>
                                    <div class="fw-bold" id="current-loss">-</div>
                                </div>
                                <div class="col-md-3">
                                    <small class="text-muted">MAE:</small>
                                    <div class="fw-bold" id="current-mae">-</div>
                                </div>
                                <div class="col-md-3">
                                    <small class="text-muted">Süre:</small>
                                    <div class="fw-bold" id="training-duration">-</div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    
    <script>
        // Model yönetimi JavaScript fonksiyonları
        let trainingInterval = null;
        let queueStatusInterval = null;

        // Sayfa yüklendiğinde model bilgilerini getir
        document.addEventListener('DOMContentLoaded', function() {
            loadModelVersions();
            loadModelStats();
            startQueueStatusChecker();
            setupNavbarEventHandlers();
        });

        // Navbar butonları için event handler'ları kur
        function setupNavbarEventHandlers() {
            // Model Metrikleri butonu
            const modelMetricsBtn = document.getElementById('modelMetricsBtn');
            if (modelMetricsBtn) {
                modelMetricsBtn.addEventListener('click', function(e) {
                    if (this.classList.contains('disabled')) {
                        e.preventDefault();
                        e.stopPropagation();
                        alert('Dosya yüklü veya analiz devam ederken model metrikleri görüntülenemez.');
                    }
                });
            }

            // Model Eğitimi butonu
            const trainModelBtn = document.getElementById('trainModelBtn');
            if (trainModelBtn) {
                trainModelBtn.addEventListener('click', function(e) {
                    if (this.classList.contains('disabled')) {
                        e.preventDefault();
                        e.stopPropagation();
                        alert('Dosya yüklü veya analiz devam ederken model eğitimi yapılamaz.');
                    }
                });
            }

            // Analiz Parametreleri butonu
            const analysisParamsBtn = document.getElementById('openAnalysisParamsModalBtn');
            if (analysisParamsBtn) {
                analysisParamsBtn.addEventListener('click', function(e) {
                    if (this.classList.contains('disabled')) {
                        e.preventDefault();
                        e.stopPropagation();
                        alert('Dosya yüklü veya analiz devam ederken analiz parametreleri değiştirilemez.');
                    }
                });
            }
        }

        // Kuyruk durumu kontrolünü başlat
        function startQueueStatusChecker() {
            // İlk kontrol
            checkQueueStatus();
            
            // 5 saniyede bir kontrol et
            queueStatusInterval = setInterval(checkQueueStatus, 5000);
        }

        // Kuyruk durumunu kontrol et
        function checkQueueStatus() {
            // Hem kuyruk durumunu hem de yüklü dosya sayısını al
            Promise.all([
                fetch('/api/debug/queue-status').then(response => response.json()),
                fetch('/api/debug/uploaded-files-count').then(response => response.json())
            ])
            .then(([queueData, uploadedFilesData]) => {
                updateModelManagementButtonsState(queueData, uploadedFilesData);
            })
            .catch(error => {
                console.error('Kuyruk durumu kontrol hatası:', error);
            });
        }

        // Model yönetimi butonlarının durumunu güncelle
        function updateModelManagementButtonsState(queueData, uploadedFilesData) {
            console.log('Kuyruk durumu:', queueData); // Debug için
            console.log('Yüklü dosya durumu:', uploadedFilesData); // Debug için
            
            // Ana sayfadaki mantık: Yüklü dosya varsa veya kuyrukta dosya varsa veya aktif analiz varsa devre dışı bırak
            const hasUploadedFiles = uploadedFilesData.uploaded_files_count > 0;
            const hasFilesInQueue = queueData.queue_size > 0 || queueData.active_analyses > 0;
            const shouldDisableButtons = hasUploadedFiles || hasFilesInQueue;
            
            console.log('Ana sayfada yüklü dosya var mı?', hasUploadedFiles); // Debug için
            console.log('Kuyrukta dosya var mı?', hasFilesInQueue); // Debug için
            console.log('Butonlar devre dışı mı?', shouldDisableButtons); // Debug için
            
            // Tüm model yönetimi butonlarını bul
            const trainButtons = document.querySelectorAll('[onclick*="trainModel"]');
            const resetButtons = document.querySelectorAll('[onclick*="resetModel"]');
            const activateButtons = document.querySelectorAll('[onclick*="activateVersion"]');
            
            // Navbar'daki butonları da kontrol et
            const navbarButtons = document.querySelectorAll('#modelMetricsBtn, #trainModelBtn, #openAnalysisParamsModalBtn');
            
            if (shouldDisableButtons) {
                // Dosya yüklü veya kuyrukta dosya varken butonları devre dışı bırak
                trainButtons.forEach(btn => {
                    btn.disabled = true;
                    btn.classList.add('disabled');
                    btn.title = 'Dosya yüklü veya analiz devam ederken model eğitimi yapılamaz';
                });
                
                resetButtons.forEach(btn => {
                    btn.disabled = true;
                    btn.classList.add('disabled');
                    btn.title = 'Dosya yüklü veya analiz devam ederken model sıfırlanamaz';
                });
                
                activateButtons.forEach(btn => {
                    btn.disabled = true;
                    btn.classList.add('disabled');
                    btn.title = 'Dosya yüklü veya analiz devam ederken model değiştirilemez';
                });
                
                // Navbar butonlarını da devre dışı bırak
                navbarButtons.forEach(btn => {
                    btn.classList.add('disabled');
                    btn.setAttribute('aria-disabled', 'true');
                    if (btn.id === 'openAnalysisParamsModalBtn') {
                        btn.removeAttribute('data-bs-toggle');
                        btn.removeAttribute('data-bs-target');
                        btn.title = 'Dosya yüklü veya analiz devam ederken parametreler değiştirilemez';
                    } else {
                        btn.title = 'Dosya yüklü veya analiz devam ederken bu işlem yapılamaz';
                    }
                });
                
            } else {
                // Dosya yüklü değil ve analiz yokken butonları aktif et
                trainButtons.forEach(btn => {
                    btn.disabled = false;
                    btn.classList.remove('disabled');
                    btn.title = '';
                });
                
                resetButtons.forEach(btn => {
                    btn.disabled = false;
                    btn.classList.remove('disabled');
                    btn.title = '';
                });
                
                activateButtons.forEach(btn => {
                    btn.disabled = false;
                    btn.classList.remove('disabled');
                    btn.title = '';
                });
                
                // Navbar butonlarını da aktif et
                navbarButtons.forEach(btn => {
                    btn.classList.remove('disabled');
                    btn.setAttribute('aria-disabled', 'false');
                    if (btn.id === 'openAnalysisParamsModalBtn') {
                        btn.setAttribute('data-bs-toggle', 'modal');
                        btn.setAttribute('data-bs-target', '#analysisParamsModal');
                    }
                    btn.title = '';
                });
            }
        }

        // Model versiyonlarını yükle
        async function loadModelVersions() {
            try {
                // Yaş modeli versiyonları
                const ageResponse = await fetch('/api/model/versions/age');
                if (ageResponse.ok) {
                    const ageData = await ageResponse.json();
                    console.log('Age API Response:', ageData); // Debug için
                    
                    // API response'da versions array'i var
                    const ageVersions = ageData.versions || [];
                    console.log('Age Versions:', ageVersions); // Debug için
                    displayVersions('age', ageVersions);
                } else {
                    console.error('Age API Error:', ageResponse.status, ageResponse.statusText);
                    document.getElementById('age-versions').innerHTML = '<span class="text-danger">API hatası</span>';
                }

                // İçerik modeli versiyonları (şimdilik statik)
                displayVersions('content', []);
            } catch (error) {
                console.error('Model versiyonları yüklenirken hata:', error);
                document.getElementById('age-versions').innerHTML = '<span class="text-danger">Yükleme hatası</span>';
            }
        }

        // Model istatistiklerini yükle
        async function loadModelStats() {
            try {
                // Yaş modeli istatistikleri
                const ageResponse = await fetch('/api/model/metrics/age');
                if (ageResponse.ok) {
                    const ageStats = await ageResponse.json();
                    updateModelStats('age', ageStats);
                }

                // İçerik modeli istatistikleri
                const contentResponse = await fetch('/api/model/metrics/content');
                if (contentResponse.ok) {
                    const contentStats = await contentResponse.json();
                    updateModelStats('content', contentStats);
                }
            } catch (error) {
                console.error('Model istatistikleri yüklenirken hata:', error);
            }
        }

        // Model versiyonlarını göster
        function displayVersions(modelType, versions) {
            const container = document.getElementById(`${modelType}-versions`);
            console.log(`Displaying ${modelType} versions:`, versions); // Debug için
            
            // Versions'ın array olduğundan emin ol
            if (!Array.isArray(versions) || versions.length === 0) {
                container.innerHTML = '<span class="text-muted">Henüz eğitilmiş versiyon yok</span>';
                
                // Aktif versiyon bilgilerini güncelle
                if (modelType === 'age') {
                    document.getElementById('age-active-version').textContent = 'Yok';
                    document.getElementById('age-status').innerHTML = '<i class="fas fa-times-circle text-danger"></i> Aktif versiyon yok';
                }
                return;
            }

            let html = '';
            versions.forEach(version => {
                const badgeClass = version.is_active ? 'bg-success' : 'bg-secondary';
                const activeText = version.is_active ? ' (Aktif)' : '';
                html += `
                    <span class="badge ${badgeClass} version-badge me-2 mb-2">
                        v${version.version}${activeText}
                        <button class="btn btn-sm btn-link text-white p-0 ms-2" 
                                onclick="activateVersion(${version.id})" 
                                ${version.is_active ? 'disabled' : ''}>
                            <i class="fas fa-play"></i>
                        </button>
                    </span>
                `;
            });
            
            container.innerHTML = html;

            // Aktif versiyonu güncelle
            if (modelType === 'age') {
                const activeVersion = versions.find(v => v.is_active);
                console.log('Active version found:', activeVersion); // Debug için
                
                if (activeVersion) {
                    document.getElementById('age-active-version').textContent = `v${activeVersion.version}`;
                    document.getElementById('age-status').innerHTML = 
                        '<i class="fas fa-check-circle status-active"></i> Aktif';
                    
                    // MAE bilgisini de güncelle
                    if (activeVersion.metrics && activeVersion.metrics.mae) {
                        document.getElementById('age-mae').textContent = `${activeVersion.metrics.mae.toFixed(2)} yaş`;
                    }
                } else {
                    document.getElementById('age-active-version').textContent = 'Yok';
                    document.getElementById('age-status').innerHTML = '<i class="fas fa-times-circle text-danger"></i> Aktif versiyon yok';
                }
            }
        }

        // Model istatistiklerini güncelle
        function updateModelStats(modelType, stats) {
            console.log(`Updating ${modelType} stats:`, stats); // Debug için
            
            if (modelType === 'age') {
                // Sadece eğitim verisi bilgisini güncelle, aktif versiyon bilgisini dokunma
                document.getElementById('age-training-data').textContent = 
                    stats.feedback_count ? `${stats.feedback_count} örnek` : 'Veri yok';
                
                // MAE bilgisini sadece aktif versiyon yoksa güncelle
                const currentMAE = document.getElementById('age-mae').textContent;
                if (currentMAE === '-' && stats.metrics && stats.metrics.mae) {
                    document.getElementById('age-mae').textContent = `${stats.metrics.mae.toFixed(2)} yaş`;
                }
            } else if (modelType === 'content') {
                document.getElementById('content-training-data').textContent = 
                    stats.feedback_count ? `${stats.feedback_count} örnek` : 'Veri yok';
            }
        }

        // Model eğitimi başlat
        async function trainModel(modelType) {
            if (confirm(`${modelType === 'age' ? 'Yaş' : 'İçerik'} modelini yeniden eğitmek istediğinizden emin misiniz?`)) {
                try {
                    showTrainingStatus(`${modelType} modeli eğitimi başlatılıyor...`, 'info');
                    
                    const response = await fetch(`/api/model/train-with-feedback`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({
                            model_type: modelType,
                            epochs: 10,
                            batch_size: 16,
                            learning_rate: 0.001
                        })
                    });

                    const result = await response.json();
                    
                    if (result.success) {
                        showTrainingStatus('Eğitim başarıyla tamamlandı!', 'success');
                        setTimeout(() => {
                            loadModelVersions();
                            loadModelStats();
                        }, 2000);
                    } else {
                        showTrainingStatus(`Eğitim hatası: ${result.message}`, 'danger');
                    }
                } catch (error) {
                    showTrainingStatus(`Eğitim hatası: ${error.message}`, 'danger');
                }
            }
        }

        // Model sıfırla
        async function resetModel(modelType) {
            if (confirm(`${modelType === 'age' ? 'Yaş' : 'İçerik'} modelini sıfırlamak istediğinizden emin misiniz? Bu işlem geri alınamaz!`)) {
                try {
                    const response = await fetch(`/api/models/reset/${modelType}`, {
                        method: 'POST'
                    });

                    const result = await response.json();
                    
                    if (response.ok) {
                        showTrainingStatus(result.message, 'success');
                        setTimeout(() => {
                            loadModelVersions();
                            loadModelStats();
                        }, 2000);
                    } else {
                        showTrainingStatus(result.error, 'danger');
                    }
                } catch (error) {
                    showTrainingStatus(`Sıfırlama hatası: ${error.message}`, 'danger');
                }
            }
        }

        // Model versiyonunu aktifleştir
        async function activateVersion(versionId) {
            try {
                const response = await fetch(`/api/model/activate/${versionId}`, {
                    method: 'POST'
                });

                const result = await response.json();
                
                if (result.success) {
                    showTrainingStatus('Model versiyonu başarıyla aktifleştirildi!', 'success');
                    setTimeout(() => {
                        loadModelVersions();
                    }, 1000);
                } else {
                    showTrainingStatus(result.message, 'danger');
                }
            } catch (error) {
                showTrainingStatus(`Aktivasyon hatası: ${error.message}`, 'danger');
            }
        }

        // Eğitim durumunu göster
        function showTrainingStatus(message, type) {
            const statusDiv = document.getElementById('training-status');
            const messageSpan = document.getElementById('training-message');
            
            statusDiv.className = `alert alert-${type}`;
            messageSpan.textContent = message;
            statusDiv.style.display = 'block';
            
            // 5 saniye sonra gizle
            setTimeout(() => {
                statusDiv.style.display = 'none';
            }, 5000);
        }
    </script>
</body>
</html> 