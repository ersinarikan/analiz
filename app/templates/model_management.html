<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Model Yönetimi - WSANALIZ</title>
    
    <!-- Favicon -->
    <link rel="icon" href="{{ url_for('static', filename='favicon.ico') }}" type="image/x-icon">
    <link rel="shortcut icon" href="{{ url_for('static', filename='favicon.ico') }}" type="image/x-icon">
    
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    
    <!-- Custom CSS -->
    <link href="{{ url_for('static', filename='css/style.css') }}" rel="stylesheet">
    <style>
        .model-card {
            transition: transform 0.2s;
        }
        .model-card:hover {
            transform: translateY(-2px);
        }
        .version-badge {
            font-size: 0.8em;
        }
        .metric-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }
        .status-active {
            color: #28a745;
        }
        .status-inactive {
            color: #6c757d;
        }
    </style>
</head>
<body>
    <!-- Navbar -->
    <nav class="navbar navbar-expand-lg navbar-dark mb-4">
        <div class="container">
            <a class="navbar-brand" href="/">
                <i class="fas fa-shield-alt me-2"></i>
                WS<span>Analiz</span>
            </a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav" aria-controls="navbarNav" aria-expanded="false" aria-label="Toggle navigation">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav ms-auto">
                    <li class="nav-item">
                        <a class="nav-link" href="/"><i class="fas fa-home me-1"></i> Ana Sayfa</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="#" id="modelMetricsBtn"><i class="fas fa-chart-line me-1"></i> Model Metrikleri</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="#" id="trainModelBtn"><i class="fas fa-brain me-1"></i> Model Eğitimi</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link active" href="/model-management"><i class="fas fa-cogs me-1"></i> Model Yönetimi</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="#" data-bs-toggle="modal" data-bs-target="#analysisParamsModal" id="openAnalysisParamsModalBtn"><i class="fas fa-cog me-1"></i> Analiz Parametreleri</a>
                    </li>
                </ul>
            </div>
        </div>
    </nav>

    <div class="container mt-4">
        <div class="row">
            <div class="col-12">
                <h1 class="mb-4">
                    <i class="fas fa-cogs me-2"></i>Model Yönetimi
                </h1>
            </div>
        </div>

        <!-- Model Kartları -->
        <div class="row">
            <!-- Yaş Tahmin Modeli -->
            <div class="col-md-6 mb-4">
                <div class="card model-card h-100">
                    <div class="card-header bg-primary text-white">
                        <h5 class="mb-0">
                            <i class="fas fa-user-clock me-2"></i>Yaş Tahmin Modeli
                        </h5>
                    </div>
                    <div class="card-body">
                        <div class="row mb-3">
                            <div class="col-6">
                                <small class="text-muted">Aktif Versiyon:</small>
                                <div class="fw-bold" id="age-active-version">Yükleniyor...</div>
                            </div>
                            <div class="col-6">
                                <small class="text-muted">Durum:</small>
                                <div id="age-status">
                                    <i class="fas fa-spinner fa-spin"></i> Kontrol ediliyor...
                                </div>
                            </div>
                        </div>
                        
                        <div class="row mb-3">
                            <div class="col-6">
                                <small class="text-muted">Eğitim Verisi:</small>
                                <div class="fw-bold" id="age-training-data">-</div>
                            </div>
                            <div class="col-6">
                                <small class="text-muted">Son MAE:</small>
                                <div class="fw-bold" id="age-mae">-</div>
                            </div>
                        </div>

                        <div class="mb-3">
                            <h6>Model Versiyonları:</h6>
                            <div id="age-versions" class="mb-3">
                                <div class="text-center">
                                    <i class="fas fa-spinner fa-spin"></i> Yükleniyor...
                                </div>
                            </div>
                        </div>

                        <div class="d-grid gap-2">
                            <button class="btn btn-success" onclick="trainModel('age')">
                                <i class="fas fa-refresh me-2"></i>Corrections Yenile
                            </button>
                            <button class="btn btn-warning" onclick="resetModel('age')">
                                <i class="fas fa-undo me-2"></i>Ensemble Sıfırla
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- CLIP Fine-tuning Modeli -->
            <div class="col-md-6 mb-4">
                <div class="card model-card h-100">
                    <div class="card-header bg-info text-white">
                        <h5 class="mb-0">
                            <i class="fas fa-brain me-2"></i>CLIP Fine-tuning Modeli
                        </h5>
                    </div>
                    <div class="card-body">
                        <div class="row mb-3">
                            <div class="col-6">
                                <small class="text-muted">Aktif Versiyon:</small>
                                <div class="fw-bold" id="clip-active-version">Yükleniyor...</div>
                            </div>
                            <div class="col-6">
                                <small class="text-muted">Durum:</small>
                                <div id="clip-status">
                                    <i class="fas fa-spinner fa-spin"></i> Kontrol ediliyor...
                                </div>
                            </div>
                        </div>
                        
                        <div class="row mb-3">
                            <div class="col-6">
                                <small class="text-muted">Feedback Sayısı:</small>
                                <div class="fw-bold" id="clip-feedback-count">-</div>
                            </div>
                            <div class="col-6">
                                <small class="text-muted">Kategoriler:</small>
                                <div class="fw-bold">5</div>
                            </div>
                        </div>

                        <div class="mb-3">
                            <h6>Model Versiyonları:</h6>
                            <div id="clip-versions" class="mb-3">
                                <div class="text-center">
                                    <i class="fas fa-spinner fa-spin"></i> Yükleniyor...
                                </div>
                            </div>
                        </div>

                        <div class="mb-3">
                            <h6>Eğitim Geçmişi:</h6>
                            <div id="clip-training-sessions" class="mb-3">
                                <div class="text-center">
                                    <i class="fas fa-spinner fa-spin"></i> Yükleniyor...
                                </div>
                            </div>
                        </div>

                        <div class="d-grid gap-2">
                            <button class="btn btn-success" onclick="trainModel('content')" id="clip-train-btn">
                                <i class="fas fa-refresh me-2"></i>CLIP Corrections Yenile
                            </button>
                            <button class="btn btn-warning" onclick="showClipVersions()" id="clip-versions-btn">
                                <i class="fas fa-list me-2"></i>Versiyonları Yönet
                            </button>
                            <button class="btn btn-info" onclick="reloadContentAnalyzer()" id="reload-analyzer-btn">
                                <i class="fas fa-sync me-2"></i>CLIP Modelini Yeniden Yükle
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Eğitim Durumu -->
        <div class="row mt-4">
            <div class="col-12">
                <div class="card">
                    <div class="card-header">
                        <h5 class="mb-0">
                            <i class="fas fa-chart-line me-2"></i>Eğitim Durumu
                        </h5>
                    </div>
                    <div class="card-body">
                        <div id="training-status" class="alert alert-info" style="display: none;">
                            <i class="fas fa-info-circle me-2"></i>
                            <span id="training-message">Eğitim durumu bekleniyor...</span>
                        </div>
                        
                        <div id="training-progress" style="display: none;">
                            <div class="progress mb-3">
                                <div class="progress-bar progress-bar-striped progress-bar-animated" 
                                     role="progressbar" style="width: 0%" id="progress-bar">
                                </div>
                            </div>
                            <div class="row">
                                <div class="col-md-3">
                                    <small class="text-muted">Epoch:</small>
                                    <div class="fw-bold" id="current-epoch">-</div>
                                </div>
                                <div class="col-md-3">
                                    <small class="text-muted">Loss:</small>
                                    <div class="fw-bold" id="current-loss">-</div>
                                </div>
                                <div class="col-md-3">
                                    <small class="text-muted">MAE:</small>
                                    <div class="fw-bold" id="current-mae">-</div>
                                </div>
                                <div class="col-md-3">
                                    <small class="text-muted">Süre:</small>
                                    <div class="fw-bold" id="training-duration">-</div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    
    <script>
        // Model yönetimi JavaScript fonksiyonları
        let trainingInterval = null;
        let queueStatusInterval = null;

        // Sayfa yüklendiğinde model bilgilerini getir
        document.addEventListener('DOMContentLoaded', function() {
            loadModelVersions();
            loadModelStats();
            loadClipData(); // CLIP verilerini yükle
            startQueueStatusChecker();
            setupNavbarEventHandlers();
        });

        // Navbar butonları için event handler'ları kur
        function setupNavbarEventHandlers() {
            // Model Metrikleri butonu
            const modelMetricsBtn = document.getElementById('modelMetricsBtn');
            if (modelMetricsBtn) {
                modelMetricsBtn.addEventListener('click', function(e) {
                    if (this.classList.contains('disabled')) {
                        e.preventDefault();
                        e.stopPropagation();
                        alert('Dosya yüklü veya analiz devam ederken model metrikleri görüntülenemez.');
                    }
                });
            }

            // Model Eğitimi butonu
            const trainModelBtn = document.getElementById('trainModelBtn');
            if (trainModelBtn) {
                trainModelBtn.addEventListener('click', function(e) {
                    if (this.classList.contains('disabled')) {
                        e.preventDefault();
                        e.stopPropagation();
                        alert('Dosya yüklü veya analiz devam ederken model eğitimi yapılamaz.');
                    }
                });
            }

            // Analiz Parametreleri butonu
            const analysisParamsBtn = document.getElementById('openAnalysisParamsModalBtn');
            if (analysisParamsBtn) {
                analysisParamsBtn.addEventListener('click', function(e) {
                    if (this.classList.contains('disabled')) {
                        e.preventDefault();
                        e.stopPropagation();
                        alert('Dosya yüklü veya analiz devam ederken analiz parametreleri değiştirilemez.');
                    }
                });
            }
        }

        // Kuyruk durumu kontrolünü başlat
        function startQueueStatusChecker() {
            // İlk kontrol
            checkQueueStatus();
            
            // 5 saniyede bir kontrol et
            queueStatusInterval = setInterval(checkQueueStatus, 5000);
        }

        // Kuyruk durumunu kontrol et
        function checkQueueStatus() {
            // Hem kuyruk durumunu hem de yüklü dosya sayısını al
            Promise.all([
                fetch('/api/debug/queue-status').then(response => response.json()),
                fetch('/api/debug/uploaded-files-count').then(response => response.json())
            ])
            .then(([queueData, uploadedFilesData]) => {
                updateModelManagementButtonsState(queueData, uploadedFilesData);
            })
            .catch(error => {
                console.error('Kuyruk durumu kontrol hatası:', error);
            });
        }

        // Model yönetimi butonlarının durumunu güncelle
        function updateModelManagementButtonsState(queueData, uploadedFilesData) {
            console.log('Kuyruk durumu:', queueData); // Debug için
            console.log('Yüklü dosya durumu:', uploadedFilesData); // Debug için
            
            // Ana sayfadaki mantık: Yüklü dosya varsa veya kuyrukta dosya varsa veya aktif analiz varsa devre dışı bırak
            const hasUploadedFiles = uploadedFilesData.uploaded_files_count > 0;
            const hasFilesInQueue = queueData.queue_size > 0 || queueData.active_analyses > 0;
            const shouldDisableButtons = hasUploadedFiles || hasFilesInQueue;
            
            console.log('Ana sayfada yüklü dosya var mı?', hasUploadedFiles); // Debug için
            console.log('Kuyrukta dosya var mı?', hasFilesInQueue); // Debug için
            console.log('Butonlar devre dışı mı?', shouldDisableButtons); // Debug için
            
            // Tüm model yönetimi butonlarını bul
            const trainButtons = document.querySelectorAll('[onclick*="trainModel"]');
            const resetButtons = document.querySelectorAll('[onclick*="resetModel"]');
            const activateButtons = document.querySelectorAll('[onclick*="activateVersion"]');
            
            // Navbar'daki butonları da kontrol et
            const navbarButtons = document.querySelectorAll('#modelMetricsBtn, #trainModelBtn, #openAnalysisParamsModalBtn');
            
            if (shouldDisableButtons) {
                // Dosya yüklü veya kuyrukta dosya varken butonları devre dışı bırak
                trainButtons.forEach(btn => {
                    btn.disabled = true;
                    btn.classList.add('disabled');
                    btn.title = 'Dosya yüklü veya analiz devam ederken model eğitimi yapılamaz';
                });
                
                resetButtons.forEach(btn => {
                    btn.disabled = true;
                    btn.classList.add('disabled');
                    btn.title = 'Dosya yüklü veya analiz devam ederken model sıfırlanamaz';
                });
                
                activateButtons.forEach(btn => {
                    btn.disabled = true;
                    btn.classList.add('disabled');
                    btn.title = 'Dosya yüklü veya analiz devam ederken model değiştirilemez';
                });
                
                // Navbar butonlarını da devre dışı bırak
                navbarButtons.forEach(btn => {
                    btn.classList.add('disabled');
                    btn.setAttribute('aria-disabled', 'true');
                    if (btn.id === 'openAnalysisParamsModalBtn') {
                        btn.removeAttribute('data-bs-toggle');
                        btn.removeAttribute('data-bs-target');
                        btn.title = 'Dosya yüklü veya analiz devam ederken parametreler değiştirilemez';
                    } else {
                        btn.title = 'Dosya yüklü veya analiz devam ederken bu işlem yapılamaz';
                    }
                });
                
            } else {
                // Dosya yüklü değil ve analiz yokken butonları aktif et
                trainButtons.forEach(btn => {
                    btn.disabled = false;
                    btn.classList.remove('disabled');
                    btn.title = '';
                });
                
                resetButtons.forEach(btn => {
                    btn.disabled = false;
                    btn.classList.remove('disabled');
                    btn.title = '';
                });
                
                activateButtons.forEach(btn => {
                    btn.disabled = false;
                    btn.classList.remove('disabled');
                    btn.title = '';
                });
                
                // Navbar butonlarını da aktif et
                navbarButtons.forEach(btn => {
                    btn.classList.remove('disabled');
                    btn.setAttribute('aria-disabled', 'false');
                    if (btn.id === 'openAnalysisParamsModalBtn') {
                        btn.setAttribute('data-bs-toggle', 'modal');
                        btn.setAttribute('data-bs-target', '#analysisParamsModal');
                    }
                    btn.title = '';
                });
            }
        }

        // Ensemble model versiyonlarını yükle
        async function loadModelVersions() {
            try {
                // Yaş ensemble versiyonları
                const ageResponse = await fetch('/api/ensemble/versions/age');
                if (ageResponse.ok) {
                    const ageData = await ageResponse.json();
                    console.log('Age Ensemble API Response:', ageData); // Debug için
                    
                    // API response'da versions array'i var
                    const ageVersions = ageData.versions || [];
                    console.log('Age Ensemble Versions:', ageVersions); // Debug için
                    displayVersions('age', ageVersions);
                } else {
                    console.error('Age Ensemble API Error:', ageResponse.status, ageResponse.statusText);
                    document.getElementById('age-versions').innerHTML = '<span class="text-danger">Ensemble API hatası</span>';
                }

                // CLIP ensemble versiyonları
                const clipResponse = await fetch('/api/ensemble/versions/content');
                if (clipResponse.ok) {
                    const clipData = await clipResponse.json();
                    console.log('CLIP Ensemble API Response:', clipData); // Debug için
                    
                    // API response'da versions array'i var
                    const clipVersions = clipData.versions || [];
                    console.log('CLIP Ensemble Versions:', clipVersions); // Debug için
                    displayVersions('content', clipVersions);
                } else {
                    console.error('CLIP Ensemble API Error:', clipResponse.status, clipResponse.statusText);
                    document.getElementById('clip-versions').innerHTML = '<span class="text-danger">Ensemble API hatası</span>';
                }
            } catch (error) {
                console.error('Ensemble versiyonları yüklenirken hata:', error);
                document.getElementById('age-versions').innerHTML = '<span class="text-danger">Ensemble yükleme hatası</span>';
                document.getElementById('clip-versions').innerHTML = '<span class="text-danger">Ensemble yükleme hatası</span>';
            }
        }

        // Ensemble model istatistiklerini yükle
        async function loadModelStats() {
            try {
                // Yaş ensemble istatistikleri
                const ageResponse = await fetch('/api/ensemble/stats/age');
                if (ageResponse.ok) {
                    const ageStats = await ageResponse.json();
                    updateEnsembleStats('age', ageStats);
                }

                // CLIP ensemble istatistikleri
                const clipResponse = await fetch('/api/ensemble/stats/content');
                if (clipResponse.ok) {
                    const clipStats = await clipResponse.json();
                    updateEnsembleStats('content', clipStats);
                }
            } catch (error) {
                console.error('Ensemble istatistikleri yüklenirken hata:', error);
            }
        }

        // Model versiyonlarını göster
        function displayVersions(modelType, versions) {
            const container = document.getElementById(`${modelType}-versions`);
            console.log(`Displaying ${modelType} versions:`, versions); // Debug için
            
            // Versions'ın array olduğundan emin ol
            if (!Array.isArray(versions) || versions.length === 0) {
                container.innerHTML = '<span class="text-muted">Henüz eğitilmiş versiyon yok</span>';
                
                // Aktif versiyon bilgilerini güncelle
                if (modelType === 'age') {
                    // Age model için de base model varsa v0 göster
                    document.getElementById('age-active-version').textContent = 'v0';
                    document.getElementById('age-status').innerHTML = '<i class="fas fa-check-circle status-active"></i> Aktif';
                } else if (modelType === 'content') {
                    // Content model için her zaman base OpenCLIP çalışıyor
                    document.getElementById('clip-active-version').textContent = 'v0';
                    document.getElementById('clip-status').innerHTML = '<i class="fas fa-check-circle status-active"></i> Aktif';
                }
                return;
            }

            let html = '';
            let activeVersionFound = false;
            
            versions.forEach(version => {
                const badgeClass = version.is_active ? 'bg-success' : 'bg-secondary';
                const activeText = version.is_active ? ' (Aktif)' : '';
                
                // Version ismi gösterimi
                let versionDisplay = '';
                if (version.version === 0) {
                    versionDisplay = `v0 (${version.version_name === 'base_openclip' ? 'En Son' : 
                                   version.version_name === 'base_model' ? 'En Son' : 
                                   'Base'})`;
                } else {
                    versionDisplay = `v${version.version}`;
                }
                
                html += `
                    <span class="badge ${badgeClass} version-badge me-2 mb-2">
                        ${versionDisplay}${activeText}
                        <button class="btn btn-sm btn-link text-white p-0 ms-2" 
                                onclick="activateVersion(${version.id})" 
                                ${version.is_active ? 'disabled' : ''}>
                            <i class="fas fa-play"></i>
                        </button>
                    </span>
                `;
                
                if (version.is_active) {
                    activeVersionFound = true;
                }
            });
            
            container.innerHTML = html;

            // Aktif versiyonu güncelle
            const activeVersion = versions.find(v => v.is_active);
            console.log('Active version found:', activeVersion); // Debug için
            
            if (modelType === 'age') {
                if (activeVersion) {
                    const versionDisplay = activeVersion.version === 0 ? 'v0' : `v${activeVersion.version}`;
                    document.getElementById('age-active-version').textContent = versionDisplay;
                    document.getElementById('age-status').innerHTML = 
                        '<i class="fas fa-check-circle status-active"></i> Aktif';
                    
                    // MAE bilgisini de güncelle
                    if (activeVersion.metrics && activeVersion.metrics.mae) {
                        document.getElementById('age-mae').textContent = `${activeVersion.metrics.mae.toFixed(2)} yaş`;
                    }
                } else {
                    // Age model için de base model varsa v0 göster
                    document.getElementById('age-active-version').textContent = 'v0';
                    document.getElementById('age-status').innerHTML = '<i class="fas fa-check-circle status-active"></i> Aktif';
                }
            } else if (modelType === 'content') {
                if (activeVersion) {
                    const versionDisplay = activeVersion.version === 0 ? 'v0' : `v${activeVersion.version}`;
                    document.getElementById('clip-active-version').textContent = versionDisplay;
                    document.getElementById('clip-status').innerHTML = 
                        '<i class="fas fa-check-circle status-active"></i> Aktif';
                } else {
                    // Content model için fallback - her zaman base çalışıyor
                    document.getElementById('clip-active-version').textContent = 'v0';
                    document.getElementById('clip-status').innerHTML = '<i class="fas fa-check-circle status-active"></i> Aktif';
                }
            }
        }

        // Ensemble istatistiklerini güncelle
        function updateEnsembleStats(modelType, stats) {
            console.log(`Updating ${modelType} ensemble stats:`, stats); // Debug için
            
            if (modelType === 'age') {
                // Ensemble corrections sayısını göster
                const correctionCount = stats.ensemble_metrics?.people_corrections || 0;
                document.getElementById('age-training-data').textContent = 
                    correctionCount > 0 ? `${correctionCount} düzeltme` : 'Düzeltme yok';
                
                // Ensemble MAE (lookup-based perfect accuracy)
                const ensembleMAE = correctionCount > 0 ? '0.00' : '1.696 (base)';
                document.getElementById('age-mae').textContent = `${ensembleMAE} yaş`;
                
                // Status güncellemesi
                if (stats.ensemble_active) {
                    const statusText = correctionCount > 0 ? 
                        '<i class="fas fa-check-circle status-active"></i> Ensemble Aktif' :
                        '<i class="fas fa-check-circle status-active"></i> Base Model';
                    document.getElementById('age-status').innerHTML = statusText;
                }
                
            } else if (modelType === 'content') {
                // CLIP ensemble corrections
                const contentCorrections = stats.ensemble_metrics?.content_corrections || 0;
                const confidenceAdjustments = stats.ensemble_metrics?.confidence_adjustments || 0;
                const totalCorrections = contentCorrections + confidenceAdjustments;
                
                document.getElementById('clip-feedback-count').textContent = 
                    totalCorrections > 0 ? `${totalCorrections} düzeltme` : 'Düzeltme yok';
                
                // Status güncellemesi
                if (stats.ensemble_active) {
                    const statusText = totalCorrections > 0 ? 
                        '<i class="fas fa-check-circle status-active"></i> Ensemble Aktif' :
                        '<i class="fas fa-check-circle status-active"></i> Base CLIP';
                    document.getElementById('clip-status').innerHTML = statusText;
                }
            }
        }

        // Ensemble corrections'ı yenile (eski eğitim yerine)
        async function trainModel(modelType) {
            if (confirm(`${modelType === 'age' ? 'Yaş' : 'İçerik'} ensemble corrections yenilemek istediğinizden emin misiniz?\n\nBu işlem yeni feedback'leri sisteme entegre eder (anında, yeniden eğitim olmadan).`)) {
                try {
                    showTrainingStatus(`${modelType} ensemble corrections yenileniyor...`, 'info');
                    
                    const response = await fetch(`/api/ensemble/refresh`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        }
                    });

                    const result = await response.json();
                    
                    if (result.success) {
                        showTrainingStatus(
                            `Ensemble başarıyla yenilendi! Yaş: ${result.age_corrections} düzeltme, CLIP: ${result.clip_corrections} düzeltme`, 
                            'success'
                        );
                        setTimeout(() => {
                            loadModelVersions();
                            loadModelStats();
                        }, 2000);
                    } else {
                        showTrainingStatus(`Ensemble yenileme hatası: ${result.error}`, 'danger');
                    }
                } catch (error) {
                    showTrainingStatus(`Ensemble hatası: ${error.message}`, 'danger');
                }
            }
        }

        // Model sıfırla
        async function resetModel(modelType) {
            if (confirm(`${modelType === 'age' ? 'Yaş' : 'İçerik'} modelini sıfırlamak istediğinizden emin misiniz? Bu işlem geri alınamaz!`)) {
                try {
                    const response = await fetch(`/api/models/reset/${modelType}`, {
                        method: 'POST'
                    });

                    const result = await response.json();
                    
                    if (response.ok) {
                        showTrainingStatus(result.message, 'success');
                        setTimeout(() => {
                            loadModelVersions();
                            loadModelStats();
                        }, 2000);
                    } else {
                        showTrainingStatus(result.error, 'danger');
                    }
                } catch (error) {
                    showTrainingStatus(`Sıfırlama hatası: ${error.message}`, 'danger');
                }
            }
        }

        // Model versiyonunu aktifleştir
        async function activateVersion(versionId) {
            try {
                const response = await fetch(`/api/models/activate/${versionId}`, {
                    method: 'POST'
                });

                const result = await response.json();
                
                if (result.success) {
                    showTrainingStatus('Model versiyonu başarıyla aktifleştirildi!', 'success');
                    setTimeout(() => {
                        loadModelVersions();
                    }, 1000);
                } else {
                    showTrainingStatus(result.message, 'danger');
                }
            } catch (error) {
                showTrainingStatus(`Aktivasyon hatası: ${error.message}`, 'danger');
            }
        }

        // Eğitim durumunu göster
        function showTrainingStatus(message, type) {
            const statusDiv = document.getElementById('training-status');
            const messageSpan = document.getElementById('training-message');
            
            statusDiv.className = `alert alert-${type}`;
            messageSpan.textContent = message;
            statusDiv.style.display = 'block';
            
            // 5 saniye sonra gizle
            setTimeout(() => {
                statusDiv.style.display = 'none';
            }, 5000);
        }

        // CLIP verilerini yükle
        async function loadClipData() {
            try {
                // CLIP istatistikleri
                const statsResponse = await fetch('/api/clip-training/statistics');
                if (statsResponse.ok) {
                    const stats = await statsResponse.json();
                    updateClipStats(stats.data);
                } else {
                    const error = await statsResponse.json();
                    console.log('CLIP stats error:', error.error);
                    updateClipStats(null);
                }

                // CLIP versiyonları
                const versionsResponse = await fetch('/api/clip-training/versions');
                if (versionsResponse.ok) {
                    const versions = await versionsResponse.json();
                    updateClipVersions(versions.data.versions);
                }

                // CLIP training sessions
                const sessionsResponse = await fetch('/api/clip-training/sessions');
                if (sessionsResponse.ok) {
                    const sessions = await sessionsResponse.json();
                    updateClipSessions(sessions.data.sessions);
                }

                // Aktif model bilgisi
                const activeResponse = await fetch('/api/clip-training/active-model');
                if (activeResponse.ok) {
                    const active = await activeResponse.json();
                    updateClipActiveModel(active.data);
                }
            } catch (error) {
                console.error('CLIP verileri yüklenirken hata:', error);
            }
        }

        // CLIP istatistiklerini güncelle
        function updateClipStats(stats) {
            if (stats) {
                document.getElementById('clip-feedback-count').textContent = stats.total_feedbacks || '0';
                document.getElementById('clip-status').innerHTML = 
                    stats.ready_for_training ? 
                    '<i class="fas fa-check-circle text-success"></i> Eğitime Hazır' :
                    '<i class="fas fa-exclamation-triangle text-warning"></i> Yetersiz Veri';
            } else {
                document.getElementById('clip-feedback-count').textContent = '0';
                document.getElementById('clip-status').innerHTML = 
                    '<i class="fas fa-exclamation-triangle text-warning"></i> Yetersiz Veri';
            }
        }

        // CLIP versiyonlarını güncelle
        function updateClipVersions(versions) {
            const container = document.getElementById('clip-versions');
            
            if (!versions || versions.length === 0) {
                container.innerHTML = '<span class="text-muted">Henüz fine-tuned versiyon yok</span>';
                return;
            }

            let html = '';
            versions.forEach(version => {
                if (version.type === 'version' || version.type === 'active') {
                    const badgeClass = version.is_active ? 'bg-success' : 'bg-secondary';
                    const activeText = version.is_active ? ' (Aktif)' : '';
                    const size = version.size ? ` (${version.size}MB)` : '';
                    
                    html += `
                        <span class="badge ${badgeClass} version-badge me-2 mb-2" title="${version.path}">
                            ${version.name}${activeText}${size}
                            ${!version.is_active ? `
                                <button class="btn btn-sm btn-link text-white p-0 ms-2" 
                                        onclick="activateClipVersion('${version.name}')" 
                                        title="Bu versiyonu aktifleştir">
                                    <i class="fas fa-play"></i>
                                </button>
                            ` : ''}
                        </span>
                    `;
                }
            });
            
            container.innerHTML = html || '<span class="text-muted">Henüz fine-tuned versiyon yok</span>';
        }

        // CLIP training sessions güncelle
        function updateClipSessions(sessions) {
            const container = document.getElementById('clip-training-sessions');
            
            if (!sessions || sessions.length === 0) {
                container.innerHTML = '<span class="text-muted">Henüz eğitim geçmişi yok</span>';
                return;
            }

            let html = '';
            sessions.slice(0, 3).forEach(session => { // Son 3 session'ı göster
                const statusClass = session.status === 'completed' ? 'success' : 
                                  session.status === 'failed' ? 'danger' : 'warning';
                const statusIcon = session.status === 'completed' ? 'check-circle' : 
                                 session.status === 'failed' ? 'times-circle' : 'clock';
                
                html += `
                    <div class="d-flex justify-content-between align-items-center mb-2">
                        <small>
                            <i class="fas fa-${statusIcon} text-${statusClass}"></i>
                            ${session.version_name} (${session.feedback_count} feedback)
                        </small>
                        <small class="text-muted">${formatDate(session.created_at)}</small>
                    </div>
                `;
            });
            
            container.innerHTML = html;
        }

        // CLIP aktif model güncelle
        function updateClipActiveModel(data) {
            if (data.model_info) {
                document.getElementById('clip-active-version').textContent = data.model_info.name || 'base_model';
            }
        }

        // CLIP training başlat
        async function startClipTraining() {
            // Training parametreleri modal'ı göster
            showClipTrainingModal();
        }

        // CLIP training modal'ını göster
        function showClipTrainingModal() {
            const modalHtml = `
                <div class="modal fade" id="clipTrainingModal" tabindex="-1">
                    <div class="modal-dialog modal-lg">
                        <div class="modal-content">
                            <div class="modal-header">
                                <h5 class="modal-title">
                                    <i class="fas fa-brain me-2"></i>CLIP Fine-tuning Parametreleri
                                </h5>
                                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                            </div>
                            <div class="modal-body">
                                <form id="clipTrainingForm">
                                    <div class="row">
                                        <div class="col-md-6">
                                            <div class="mb-3">
                                                <label for="clipLearningRate" class="form-label">Learning Rate</label>
                                                <input type="number" class="form-control" id="clipLearningRate" 
                                                       value="0.00001" step="0.000001" min="0.000001">
                                            </div>
                                        </div>
                                        <div class="col-md-6">
                                            <div class="mb-3">
                                                <label for="clipBatchSize" class="form-label">Batch Size</label>
                                                <input type="number" class="form-control" id="clipBatchSize" 
                                                       value="16" min="1" max="64">
                                            </div>
                                        </div>
                                    </div>
                                    <div class="row">
                                        <div class="col-md-6">
                                            <div class="mb-3">
                                                <label for="clipEpochs" class="form-label">Epochs</label>
                                                <input type="number" class="form-control" id="clipEpochs" 
                                                       value="5" min="1" max="20">
                                            </div>
                                        </div>
                                        <div class="col-md-6">
                                            <div class="mb-3">
                                                <label for="clipTrainSplit" class="form-label">Train Split (%)</label>
                                                <input type="number" class="form-control" id="clipTrainSplit" 
                                                       value="80" min="60" max="90">
                                            </div>
                                        </div>
                                    </div>
                                    <div class="mb-3">
                                        <label class="form-label">Kategoriler</label>
                                        <div class="row">
                                            <div class="col-md-6">
                                                <div class="form-check">
                                                    <input class="form-check-input" type="checkbox" id="catViolence" checked>
                                                    <label class="form-check-label" for="catViolence">Violence</label>
                                                </div>
                                                <div class="form-check">
                                                    <input class="form-check-input" type="checkbox" id="catAdult" checked>
                                                    <label class="form-check-label" for="catAdult">Adult Content</label>
                                                </div>
                                                <div class="form-check">
                                                    <input class="form-check-input" type="checkbox" id="catHarassment" checked>
                                                    <label class="form-check-label" for="catHarassment">Harassment</label>
                                                </div>
                                            </div>
                                            <div class="col-md-6">
                                                <div class="form-check">
                                                    <input class="form-check-input" type="checkbox" id="catWeapon" checked>
                                                    <label class="form-check-label" for="catWeapon">Weapon</label>
                                                </div>
                                                <div class="form-check">
                                                    <input class="form-check-input" type="checkbox" id="catDrug" checked>
                                                    <label class="form-check-label" for="catDrug">Drug</label>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </form>
                            </div>
                            <div class="modal-footer">
                                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">İptal</button>
                                <button type="button" class="btn btn-success" onclick="executeClipTraining()">
                                    <i class="fas fa-play me-2"></i>Eğitimi Başlat
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            
            // Modal'ı DOM'a ekle
            document.body.insertAdjacentHTML('beforeend', modalHtml);
            
            // Modal'ı göster
            const modal = new bootstrap.Modal(document.getElementById('clipTrainingModal'));
            modal.show();
            
            // Modal kapandığında DOM'dan kaldır
            document.getElementById('clipTrainingModal').addEventListener('hidden.bs.modal', function() {
                this.remove();
            });
        }

        // CLIP training'i çalıştır
        async function executeClipTraining() {
            try {
                // Form verilerini al
                const learningRate = parseFloat(document.getElementById('clipLearningRate').value);
                const batchSize = parseInt(document.getElementById('clipBatchSize').value);
                const epochs = parseInt(document.getElementById('clipEpochs').value);
                const trainSplit = parseFloat(document.getElementById('clipTrainSplit').value) / 100;
                
                // Seçili kategorileri al
                const categories = [];
                if (document.getElementById('catViolence').checked) categories.push('violence');
                if (document.getElementById('catAdult').checked) categories.push('adult_content');
                if (document.getElementById('catHarassment').checked) categories.push('harassment');
                if (document.getElementById('catWeapon').checked) categories.push('weapon');
                if (document.getElementById('catDrug').checked) categories.push('drug');
                
                if (categories.length === 0) {
                    alert('En az bir kategori seçmelisiniz!');
                    return;
                }
                
                // Modal'ı kapat
                bootstrap.Modal.getInstance(document.getElementById('clipTrainingModal')).hide();
                
                // Training'i başlat
                showTrainingStatus('CLIP Fine-tuning başlatılıyor...', 'info');
                
                const response = await fetch('/api/clip-training/start-training', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        learning_rate: learningRate,
                        batch_size: batchSize,
                        epochs: epochs,
                        train_split: trainSplit,
                        categories: categories,
                        min_feedback_count: 50
                    })
                });

                const result = await response.json();
                
                if (result.success) {
                    showTrainingStatus(`CLIP Fine-tuning başlatıldı! Session ID: ${result.data.session_id}`, 'success');
                    
                    // Training durumunu takip et
                    startClipTrainingMonitor(result.data.session_id);
                    
                    // Verileri yenile
                    setTimeout(() => {
                        loadClipData();
                    }, 2000);
                } else {
                    showTrainingStatus(`CLIP Training hatası: ${result.error}`, 'danger');
                }
            } catch (error) {
                showTrainingStatus(`CLIP Training hatası: ${error.message}`, 'danger');
            }
        }

        // CLIP training durumunu takip et
        function startClipTrainingMonitor(sessionId) {
            const interval = setInterval(async () => {
                try {
                    const response = await fetch(`/api/clip-training/sessions/${sessionId}`);
                    if (response.ok) {
                        const result = await response.json();
                        const session = result.data;
                        
                        if (session.status === 'completed') {
                            showTrainingStatus('CLIP Fine-tuning başarıyla tamamlandı!', 'success');
                            clearInterval(interval);
                            loadClipData();
                        } else if (session.status === 'failed') {
                            showTrainingStatus('CLIP Fine-tuning başarısız oldu!', 'danger');
                            clearInterval(interval);
                        } else {
                            showTrainingStatus(`CLIP Fine-tuning devam ediyor... (${session.status})`, 'info');
                        }
                    }
                } catch (error) {
                    console.error('Training monitor hatası:', error);
                }
            }, 5000);
        }

        // CLIP versiyon yönetimi
        function showClipVersions() {
            // Versiyonları yönetmek için modal göster
            alert('CLIP versiyon yönetimi yakında eklenecek!');
        }

        // CLIP versiyonunu aktifleştir
        async function activateClipVersion(versionName) {
            if (confirm(`${versionName} versiyonunu aktifleştirmek istediğinizden emin misiniz?`)) {
                try {
                    const response = await fetch(`/api/clip-training/versions/${versionName}/activate`, {
                        method: 'POST'
                    });

                    const result = await response.json();
                    
                    if (result.success) {
                        showTrainingStatus('CLIP model versiyonu başarıyla aktifleştirildi!', 'success');
                        setTimeout(() => {
                            loadClipData();
                        }, 1000);
                    } else {
                        showTrainingStatus(`Aktivasyon hatası: ${result.error}`, 'danger');
                    }
                } catch (error) {
                    showTrainingStatus(`Aktivasyon hatası: ${error.message}`, 'danger');
                }
            }
        }

        // Tarih formatlama yardımcı fonksiyonu
        function formatDate(dateString) {
            if (!dateString) return '-';
            const date = new Date(dateString);
            return date.toLocaleDateString('tr-TR') + ' ' + date.toLocaleTimeString('tr-TR', {hour: '2-digit', minute: '2-digit'});
        }

        // ContentAnalyzer'ı yeniden yükle
        async function reloadContentAnalyzer() {
            if (confirm('CLIP modelini yeniden yüklemek istediğinizden emin misiniz? Bu işlem birkaç dakika sürebilir.')) {
                try {
                    showTrainingStatus('CLIP modeli yeniden yükleniyor...', 'info');
                    
                    const response = await fetch('/api/models/reload-content-analyzer', {
                        method: 'POST'
                    });

                    const result = await response.json();
                    
                    if (response.ok) {
                        showTrainingStatus(result.message, 'success');
                        setTimeout(() => {
                            loadModelVersions();
                            loadModelStats();
                            loadClipData();
                        }, 2000);
                    } else {
                        showTrainingStatus(result.error, 'danger');
                    }
                } catch (error) {
                    showTrainingStatus(`Yeniden yükleme hatası: ${error.message}`, 'danger');
                }
            }
        }
    </script>
</body>
</html> 